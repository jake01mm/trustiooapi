# Trusioo API å·¥å…·é›†

è¿™ä¸ªç›®å½•åŒ…å«äº† Trusioo API é¡¹ç›®çš„å„ç§å¼€å‘å’Œç»´æŠ¤å·¥å…·ã€‚

## ğŸ› ï¸ å¯ç”¨å·¥å…·

### æ•°æ®åº“è¿ç§»å·¥å…· (æ¨èä½¿ç”¨)

åŸºäº `golang-migrate` çš„ç°ä»£åŒ–è¿ç§»ç³»ç»Ÿï¼Œä¸“ä¸º Neon Database ä¼˜åŒ–ï¼š

```bash
# åˆå§‹åŒ–è¿ç§»ç³»ç»Ÿ
make db-init

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
make db-status

# æ‰§è¡Œè¿ç§»
make db-migrate

# å›æ»šè¿ç§»
make db-rollback

# åˆ›å»ºæ–°è¿ç§»
make db-create NAME=your_migration_name

# æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make help
```

**è¯¦ç»†æ–‡æ¡£**: [../docs/MIGRATIONS.md](../docs/MIGRATIONS.md)

### ä¼ ç»Ÿå·¥å…· (å‘åå…¼å®¹)

ä¸ºäº†å‘åå…¼å®¹ä¿ç•™çš„æ—§å·¥å…·ï¼ˆä½äº `db/legacy/` ç›®å½•ï¼‰ï¼š

- `db/legacy/migrate/migrate.go` - æ—§çš„è¿ç§»å·¥å…·
- `db/legacy/alter/alter.go` - è¡¨ç»“æ„ä¿®æ”¹å·¥å…·
- `db/legacy/test/test.go` - æ•°æ®åº“è¿æ¥æµ‹è¯•
- `db/legacy/verify/verify.go` - è¡¨ç»“æ„éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¦–æ¬¡ä½¿ç”¨

```bash
cd tools
make db-init
```

### 2. æ—¥å¸¸å¼€å‘

```bash
# æ£€æŸ¥å½“å‰çŠ¶æ€
make db-status

# åˆ›å»ºæ–°åŠŸèƒ½çš„è¿ç§»
make db-create NAME=add_user_preferences

# ç¼–è¾‘ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ
make db-migrate
```

### 3. å®‰å…¨æ“ä½œ

```bash
# æ‰§è¡Œé‡è¦è¿ç§»å‰åˆ›å»ºå¤‡ä»½
make db-backup

# å¦‚æœéœ€è¦å›æ»š
make db-rollback
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
tools/
â”œâ”€â”€ Makefile              # ä¸»è¦å‘½ä»¤å…¥å£
â”œâ”€â”€ README.md            # æœ¬æ–‡ä»¶
â”œâ”€â”€ db/                  # æ•°æ®åº“å·¥å…·
â”‚   â”œâ”€â”€ README.md        # æ•°æ®åº“å·¥å…·è¯´æ˜
â”‚   â”œâ”€â”€ migrate_new.go   # ä¸»è¿ç§»å·¥å…· (æ¨è)
â”‚   â”œâ”€â”€ status.go        # çŠ¶æ€æ£€æŸ¥
â”‚   â”œâ”€â”€ init.go          # åˆå§‹åŒ–å·¥å…·
â”‚   â”œâ”€â”€ backup.go        # å¤‡ä»½å·¥å…·
â”‚   â””â”€â”€ legacy/          # ä¼ ç»Ÿå·¥å…· (å‘åå…¼å®¹)
â”‚       â”œâ”€â”€ migrate/     # æ—§è¿ç§»å·¥å…·
â”‚       â”œâ”€â”€ alter/       # è¡¨ä¿®æ”¹å·¥å…·
â”‚       â”œâ”€â”€ test/        # è¿æ¥æµ‹è¯•
â”‚       â””â”€â”€ verify/      # ç»“æ„éªŒè¯
â”œâ”€â”€ admin/               # ç®¡ç†å‘˜å·¥å…·
â”‚   â””â”€â”€ check_password.go
â””â”€â”€ debug/               # è°ƒè¯•å·¥å…·
    â””â”€â”€ check_data.go
```

## ğŸ”„ è¿ç§»ç³»ç»Ÿå¯¹æ¯”

### æ–°ç³»ç»Ÿ vs æ—§ç³»ç»Ÿ

| ç‰¹æ€§ | æ–°ç³»ç»Ÿ (golang-migrate) | æ—§ç³»ç»Ÿ |
|------|-------------------------|--------|
| ç‰ˆæœ¬æ§åˆ¶ | âœ… è‡ªåŠ¨ç‰ˆæœ¬è¿½è¸ª | âŒ æ‰‹åŠ¨ç®¡ç† |
| å›æ»šåŠŸèƒ½ | âœ… è‡ªåŠ¨å›æ»šè„šæœ¬ | âŒ éœ€è¦æ‰‹åŠ¨ç¼–å†™ |
| çŠ¶æ€è¿½è¸ª | âœ… è¯¦ç»†çŠ¶æ€æ˜¾ç¤º | âŒ æ— çŠ¶æ€æ˜¾ç¤º |
| å®‰å…¨æœºåˆ¶ | âœ… å¤‡ä»½+ç¡®è®¤æç¤º | âŒ ç›´æ¥æ‰§è¡Œ |
| å¹¶å‘ä¿æŠ¤ | âœ… é˜²æ­¢åŒæ—¶æ‰§è¡Œ | âŒ æ— ä¿æŠ¤ |
| å¹‚ç­‰æ€§ | âœ… å¯é‡å¤æ‰§è¡Œ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |

### è¿ç§»å»ºè®®

**æ–°é¡¹ç›®**: ç›´æ¥ä½¿ç”¨æ–°çš„è¿ç§»ç³»ç»Ÿ

**ç°æœ‰é¡¹ç›®**: 
1. å…ˆä½¿ç”¨ `make db-status` æ£€æŸ¥å½“å‰çŠ¶æ€
2. å¦‚æœæ•°æ®åº“å·²å­˜åœ¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
3. åç»­ä½¿ç”¨æ–°ç³»ç»Ÿåˆ›å»ºè¿ç§»

## ğŸ›¡ï¸ æœ€ä½³å®è·µ

### 1. å¼€å‘æµç¨‹

```bash
# 1. å¼€å§‹æ–°åŠŸèƒ½å¼€å‘å‰
make db-status

# 2. å¦‚éœ€æ•°æ®åº“å˜æ›´ï¼Œåˆ›å»ºè¿ç§»
make db-create NAME=add_feature_x

# 3. ç¼–è¾‘è¿ç§»æ–‡ä»¶
# 4. æ‰§è¡Œè¿ç§»
make db-migrate

# 5. æµ‹è¯•åŠŸèƒ½
# 6. å¦‚æœ‰é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»š
make db-rollback
```

### 2. å›¢é˜Ÿåä½œ

```bash
# æ‹‰å–ä»£ç åæ£€æŸ¥æ˜¯å¦æœ‰æ–°è¿ç§»
make db-status

# å¦‚æœ‰å¾…å¤„ç†è¿ç§»ï¼Œæ‰§è¡Œå®ƒä»¬
make db-migrate
```

### 3. éƒ¨ç½²æµç¨‹

```bash
# ç”Ÿäº§éƒ¨ç½²å‰
make db-backup          # å¤‡ä»½æ•°æ®åº“
make db-migrate         # æ‰§è¡Œè¿ç§»
# éƒ¨ç½²åº”ç”¨
# éªŒè¯åŠŸèƒ½æ­£å¸¸
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿ç§»å¤±è´¥å¯¼è‡´è„çŠ¶æ€**
   ```bash
   make db-status  # æŸ¥çœ‹çŠ¶æ€
   make db-force N=<version>  # å¼ºåˆ¶ä¿®å¤
   ```

2. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
   - ç¡®è®¤ Neon Database è¿æ¥ä¿¡æ¯æ­£ç¡®

3. **ç‰ˆæœ¬å†²çª**
   - æ£€æŸ¥ `migrations/` ç›®å½•ä¸‹çš„æ–‡ä»¶
   - ç¡®ä¿ç‰ˆæœ¬å·è¿ç»­

### è·å–å¸®åŠ©

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
make help

# æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
cat ../docs/MIGRATIONS.md
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [é¡¹ç›®ä¸»é¡µ](../README.md)
- [è¿ç§»ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£](../docs/MIGRATIONS.md)
- [golang-migrate å®˜æ–¹æ–‡æ¡£](https://github.com/golang-migrate/migrate)
- [Neon Database æ–‡æ¡£](https://neon.tech/docs)

---

**æ³¨æ„**: å»ºè®®ä¼˜å…ˆä½¿ç”¨æ–°çš„è¿ç§»ç³»ç»Ÿ (`make db-*` å‘½ä»¤)ï¼Œæ—§å·¥å…·ä»…ç”¨äºç‰¹æ®Šæƒ…å†µæˆ–å‘åå…¼å®¹ã€‚